from configs.base import SuccessResponse, FailureResponse, JsonResponse
from robot.services.larkService import handler_lark_msg, execute_lark_sd_task, execute_lark_mj_task
from robot.models import LarkBotInfo
from ibuser.models import IBUser

# æ·»åŠ é£ä¹¦æœºå™¨äºº
def add_lark_bot(request):
    user = IBUser.objects.get(username=request.username)
    larkBotInfos = LarkBotInfo.objects.filter(app_id=request.params.get("app_id"))
    if len(larkBotInfos) == 0:
        LarkBotInfo.objects.create(
            user=user,
            app_id=request.params.get("app_id"),
            app_secret=request.params.get("app_secret"),
            type="mj&sd&gpt",
            extra_config={
                "mj_config": {
                    "help_command": "/mjhelp",
                    "help_text": "[ç«ç‘°]ç»˜å›¾æœºå™¨äººä½¿ç”¨æŒ‡å—[ç«ç‘°]\n------------------------------\nğŸ¨ ç”Ÿæˆå›¾ç‰‡å‘½ä»¤ \nè¾“å…¥: /imagine prompt\n<prompt> å³ä½ æçš„ç»˜ç”»éœ€æ±‚\n------------------------------\nğŸŒˆ å˜æ¢å›¾ç‰‡å‘½ä»¤ ï¸\nè¾“å…¥: /up asdf1234567 U1\nè¾“å…¥: /up asdf1234567 V1\n<asdf1234567> ä»£è¡¨æ¶ˆæ¯IDï¼Œ<U>ä»£è¡¨æ”¾å¤§ï¼Œ<V>ä»£è¡¨ç»†è‡´å˜åŒ–ï¼Œ<1>ä»£è¡¨ç¬¬å‡ å¼ å›¾\n------------------------------\nğŸ“• é™„åŠ å‚æ•°\n1.è§£é‡Šï¼šé™„åŠ å‚æ•°æŒ‡çš„æ˜¯åœ¨promptåæºå¸¦çš„å‚æ•°ï¼Œå¯ä»¥ä½¿ä½ çš„ç»˜ç”»æ›´åŠ åˆ«å…·ä¸€æ ¼Â· è¾“å…¥ /imagine prompt --v 5 --ar 16:9\n2.ä½¿ç”¨ï¼šéœ€è¦ä½¿ç”¨--key value ï¼Œkeyå’Œvalueä¹‹é—´éœ€è¦ç©ºæ ¼éš”å¼€ï¼Œæ¯ä¸ªé™„åŠ å‚æ•°ä¹‹é—´ä¹Ÿéœ€è¦ç©ºæ ¼éš”å¼€\n3.è¯¦è§£ï¼šä¸Šè¿°é™„åŠ å‚æ•°è§£é‡Š <v>ç‰ˆæœ¬key <5>ç‰ˆæœ¬å· <ar>æ¯”ä¾‹keyï¼Œ<16:9>æ¯”ä¾‹value\n------------------------------\nğŸ“— é™„åŠ å‚æ•°åˆ—è¡¨\n1.(--version) æˆ– (--v) ã€Šç‰ˆæœ¬ã€‹ å‚æ•° 1ï¼Œ2ï¼Œ3ï¼Œ4ï¼Œ5 é»˜è®¤5ï¼Œä¸å¯ä¸nijiåŒç”¨\n2.(--niji)ã€Šå¡é€šç‰ˆæœ¬ã€‹ å‚æ•° ç©ºæˆ– 5 é»˜è®¤ç©ºï¼Œä¸å¯ä¸ç‰ˆæœ¬åŒç”¨\n3.(--aspect) æˆ– (--ar) ã€Šæ¨ªçºµæ¯”ã€‹ å‚æ•° n:n ï¼Œé»˜è®¤1:1 ï¼Œä¸åŒç‰ˆæœ¬ç•¥æœ‰å·®å¼‚ï¼Œå…·ä½“è¯¦è§æœºå™¨äººæç¤º\n4.(--chaos) æˆ– (--c) ã€Šå™ªç‚¹ã€‹å‚æ•° 0-100 é»˜è®¤0\n5.(--quality) æˆ– (--q) ã€Šæ¸…æ™°åº¦ã€‹å‚æ•° .25 .5 1 2 åˆ†åˆ«ä»£è¡¨ï¼Œä¸€èˆ¬ï¼Œæ¸…æ™°ï¼Œé«˜æ¸…ï¼Œè¶…é«˜æ¸…ï¼Œé»˜è®¤1\n6.(--style) ã€Šé£æ ¼ã€‹å‚æ•° 4a,4b,4c (v4)ç‰ˆæœ¬å¯ç”¨ï¼Œå‚æ•° expressive,cute (niji5)ç‰ˆæœ¬å¯ç”¨\n7.(--stylize) æˆ– (--s)) ã€Šé£æ ¼åŒ–ã€‹å‚æ•° 1-1000 v3 625-60000\n8.(--seed) ã€Šç§å­ã€‹å‚æ•° 0-4294967295 å¯è‡ªå®šä¹‰ä¸€ä¸ªæ•°å€¼é…åˆ(sameseed)ä½¿ç”¨\n9.(--sameseed) ã€Šç›¸åŒç§å­ã€‹å‚æ•° 0-4294967295 å¯è‡ªå®šä¹‰ä¸€ä¸ªæ•°å€¼é…åˆ(seed)ä½¿ç”¨\n10.(--tile) ã€Šé‡å¤æ¨¡å¼ã€‹å‚æ•° ç©º",
                },
                "sd_config": {
                    "help_command": "/sdhelp",
                    "help_text": "[ç«ç‘°]ç»˜å›¾æœºå™¨äººä½¿ç”¨æŒ‡å—[ç«ç‘°]\n-------------------------------------\n[ç¤¼ç‰©] ä½¿ç”¨æ–¹æ³•[ç¤¼ç‰©]\n[åº†ç¥]@æœºå™¨äºº+å›¾ç‰‡ID+å…³é”®è¯+å‚æ•°\n-------------------------------------\nğŸ“• é™„åŠ å‚æ•°\n1.è§£é‡Šï¼šé™„åŠ å‚æ•°æŒ‡çš„æ˜¯åœ¨promptåæºå¸¦çš„å‚æ•°ï¼Œå¯ä»¥ä½¿ä½ çš„ç»˜ç”»æ›´åŠ åˆ«å…·ä¸€æ ¼\n2.ä½¿ç”¨ï¼šéœ€è¦ä½¿ç”¨--key value ï¼Œkeyå’Œvalueä¹‹é—´éœ€è¦ç©ºæ ¼éš”å¼€ï¼Œæ¯ä¸ªé™„åŠ å‚æ•°ä¹‹é—´ä¹Ÿéœ€è¦ç©ºæ ¼éš”å¼€\n3.è¯¦è§£ï¼šä¸Šè¿°é™„åŠ å‚æ•°è§£é‡Š<ar>æ¯”ä¾‹keyï¼Œ<16:9>æ¯”ä¾‹value\n-------------------------------------\nğŸ“•é™„åŠ å‚æ•°åˆ—è¡¨\n1.ï¼ˆ--ar) ã€Šå®½é«˜æ¯”ã€‹ æ ¼å¼ï¼š --ar16ï¼š9 ï¼Œé»˜è®¤1:1\n2.ï¼ˆ--seedï¼‰ã€Šç§å­æ•°ã€‹æ ¼å¼ï¼š--seed555648ï¼Œé»˜è®¤-1ï¼Œç§å­æ•°å€¼-1åˆ°æ— é™å¤§ï¼Œ-1ç­‰äºéšæœºç”Ÿæˆä¸€ä¸ªç§å­æ•°ï¼Œç§å­æ•°ä¸åŒç”»å›¾å°±ä¸åŒã€‚",
                },
                "gpt_config": {
                    "model": "gpt-3.5-turbo",
                    "api_key": "sk-BFeWGkbTkBi8SQDyIlccQBYJGeAGgNAbVZHbUoqzMn4h40x7",
                    "base_url": "https://api.chatanywhere.com.cn",
                    "help_text": "æ ¼å¼ @æœºå™¨äºº + é—®é¢˜",
                    "multi_mode": 0,
                    "help_command": "/gpthelp"
                }
            }
        )
    else:
        for larkBotInfo in larkBotInfos:
            larkBotInfo.app_secret = request.params.get("app_secret")
            larkBotInfo.type = "mj&sd&gpt"
            larkBotInfo.user = user
            larkBotInfo.extra_config = {
                "mj_config": {
                    "help_command": "/mjhelp",
                    "help_text": "[ç«ç‘°]ç»˜å›¾æœºå™¨äººä½¿ç”¨æŒ‡å—[ç«ç‘°]\n------------------------------\nğŸ¨ ç”Ÿæˆå›¾ç‰‡å‘½ä»¤ \nè¾“å…¥: /imagine prompt\n<prompt> å³ä½ æçš„ç»˜ç”»éœ€æ±‚\n------------------------------\nğŸŒˆ å˜æ¢å›¾ç‰‡å‘½ä»¤ ï¸\nè¾“å…¥: /up asdf1234567 U1\nè¾“å…¥: /up asdf1234567 V1\n<asdf1234567> ä»£è¡¨æ¶ˆæ¯IDï¼Œ<U>ä»£è¡¨æ”¾å¤§ï¼Œ<V>ä»£è¡¨ç»†è‡´å˜åŒ–ï¼Œ<1>ä»£è¡¨ç¬¬å‡ å¼ å›¾\n------------------------------\nğŸ“• é™„åŠ å‚æ•°\n1.è§£é‡Šï¼šé™„åŠ å‚æ•°æŒ‡çš„æ˜¯åœ¨promptåæºå¸¦çš„å‚æ•°ï¼Œå¯ä»¥ä½¿ä½ çš„ç»˜ç”»æ›´åŠ åˆ«å…·ä¸€æ ¼Â· è¾“å…¥ /imagine prompt --v 5 --ar 16:9\n2.ä½¿ç”¨ï¼šéœ€è¦ä½¿ç”¨--key value ï¼Œkeyå’Œvalueä¹‹é—´éœ€è¦ç©ºæ ¼éš”å¼€ï¼Œæ¯ä¸ªé™„åŠ å‚æ•°ä¹‹é—´ä¹Ÿéœ€è¦ç©ºæ ¼éš”å¼€\n3.è¯¦è§£ï¼šä¸Šè¿°é™„åŠ å‚æ•°è§£é‡Š <v>ç‰ˆæœ¬key <5>ç‰ˆæœ¬å· <ar>æ¯”ä¾‹keyï¼Œ<16:9>æ¯”ä¾‹value\n------------------------------\nğŸ“— é™„åŠ å‚æ•°åˆ—è¡¨\n1.(--version) æˆ– (--v) ã€Šç‰ˆæœ¬ã€‹ å‚æ•° 1ï¼Œ2ï¼Œ3ï¼Œ4ï¼Œ5 é»˜è®¤5ï¼Œä¸å¯ä¸nijiåŒç”¨\n2.(--niji)ã€Šå¡é€šç‰ˆæœ¬ã€‹ å‚æ•° ç©ºæˆ– 5 é»˜è®¤ç©ºï¼Œä¸å¯ä¸ç‰ˆæœ¬åŒç”¨\n3.(--aspect) æˆ– (--ar) ã€Šæ¨ªçºµæ¯”ã€‹ å‚æ•° n:n ï¼Œé»˜è®¤1:1 ï¼Œä¸åŒç‰ˆæœ¬ç•¥æœ‰å·®å¼‚ï¼Œå…·ä½“è¯¦è§æœºå™¨äººæç¤º\n4.(--chaos) æˆ– (--c) ã€Šå™ªç‚¹ã€‹å‚æ•° 0-100 é»˜è®¤0\n5.(--quality) æˆ– (--q) ã€Šæ¸…æ™°åº¦ã€‹å‚æ•° .25 .5 1 2 åˆ†åˆ«ä»£è¡¨ï¼Œä¸€èˆ¬ï¼Œæ¸…æ™°ï¼Œé«˜æ¸…ï¼Œè¶…é«˜æ¸…ï¼Œé»˜è®¤1\n6.(--style) ã€Šé£æ ¼ã€‹å‚æ•° 4a,4b,4c (v4)ç‰ˆæœ¬å¯ç”¨ï¼Œå‚æ•° expressive,cute (niji5)ç‰ˆæœ¬å¯ç”¨\n7.(--stylize) æˆ– (--s)) ã€Šé£æ ¼åŒ–ã€‹å‚æ•° 1-1000 v3 625-60000\n8.(--seed) ã€Šç§å­ã€‹å‚æ•° 0-4294967295 å¯è‡ªå®šä¹‰ä¸€ä¸ªæ•°å€¼é…åˆ(sameseed)ä½¿ç”¨\n9.(--sameseed) ã€Šç›¸åŒç§å­ã€‹å‚æ•° 0-4294967295 å¯è‡ªå®šä¹‰ä¸€ä¸ªæ•°å€¼é…åˆ(seed)ä½¿ç”¨\n10.(--tile) ã€Šé‡å¤æ¨¡å¼ã€‹å‚æ•° ç©º",
                },
                "sd_config": {
                    "help_command": "/sdhelp",
                    "help_text": "[ç«ç‘°]ç»˜å›¾æœºå™¨äººä½¿ç”¨æŒ‡å—[ç«ç‘°]\n-------------------------------------\n[ç¤¼ç‰©] ä½¿ç”¨æ–¹æ³•[ç¤¼ç‰©]\n[åº†ç¥]@æœºå™¨äºº+å›¾ç‰‡ID+å…³é”®è¯+å‚æ•°\n-------------------------------------\nğŸ“• é™„åŠ å‚æ•°\n1.è§£é‡Šï¼šé™„åŠ å‚æ•°æŒ‡çš„æ˜¯åœ¨promptåæºå¸¦çš„å‚æ•°ï¼Œå¯ä»¥ä½¿ä½ çš„ç»˜ç”»æ›´åŠ åˆ«å…·ä¸€æ ¼\n2.ä½¿ç”¨ï¼šéœ€è¦ä½¿ç”¨--key value ï¼Œkeyå’Œvalueä¹‹é—´éœ€è¦ç©ºæ ¼éš”å¼€ï¼Œæ¯ä¸ªé™„åŠ å‚æ•°ä¹‹é—´ä¹Ÿéœ€è¦ç©ºæ ¼éš”å¼€\n3.è¯¦è§£ï¼šä¸Šè¿°é™„åŠ å‚æ•°è§£é‡Š<ar>æ¯”ä¾‹keyï¼Œ<16:9>æ¯”ä¾‹value\n-------------------------------------\nğŸ“•é™„åŠ å‚æ•°åˆ—è¡¨\n1.ï¼ˆ--ar) ã€Šå®½é«˜æ¯”ã€‹ æ ¼å¼ï¼š --ar16ï¼š9 ï¼Œé»˜è®¤1:1\n2.ï¼ˆ--seedï¼‰ã€Šç§å­æ•°ã€‹æ ¼å¼ï¼š--seed555648ï¼Œé»˜è®¤-1ï¼Œç§å­æ•°å€¼-1åˆ°æ— é™å¤§ï¼Œ-1ç­‰äºéšæœºç”Ÿæˆä¸€ä¸ªç§å­æ•°ï¼Œç§å­æ•°ä¸åŒç”»å›¾å°±ä¸åŒã€‚",
                },
                "gpt_config": {
                    "model": "gpt-3.5-turbo",
                    "api_key": "sk-BFeWGkbTkBi8SQDyIlccQBYJGeAGgNAbVZHbUoqzMn4h40x7",
                    "base_url": "https://api.chatanywhere.com.cn",
                    "help_text": "æ ¼å¼ @æœºå™¨äºº + é—®é¢˜",
                    "multi_mode": 0,
                    "help_command": "/gpthelp"
                }
            }
            larkBotInfo.save()

    return SuccessResponse("æœºå™¨äººæ·»åŠ æˆåŠŸ")

# é£ä¹¦æœºå™¨äººç›‘å¬æ–¹æ³•
def lark_bot_listener(request):
    handler_lark_msg(params=request.params)
    if request.params.get("challenge"):
        return JsonResponse({
            "challenge": request.params.get("challenge")
        })
    return SuccessResponse("")

# æ‰§è¡Œé£ä¹¦æœºå™¨äººç›¸å…³ä»»åŠ¡
def execute_lark_task(request):
    try:
        execute_lark_sd_task()
        execute_lark_mj_task()
        return SuccessResponse("æ‰§è¡ŒæˆåŠŸ")
    except:
        return FailureResponse("æ‰§è¡Œå¤±è´¥")






























